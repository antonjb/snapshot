'use strict';var constants={CLIENT_ID:'151109002640-6hsca3c8lv5eutorkavk157rle1rjsgt.apps.googleusercontent.com',DRIVE_FOLDER:'Snapshot Photos',IMAGE_TYPE:'image/jpeg',SUPPORTS_BGSYNC:'SyncManager'in self,SUPPORTS_IMAGE_CAPTURE:'ImageCapture'in self,SUPPORTS_MEDIA_DEVICES:'mediaDevices'in navigator,SYNC_FREQUENCY:2e4};function dataUrlToArrayBuffer(e){const t=atob(e.split(',')[1]),a=new Uint8Array(t.length);for(let r=0;r<t.length;r++)a[r]=t.charCodeAt(r);return a.buffer}async function canvasToBlob(e,t){if(e.toBlob){const a=new Promise((a)=>{e.toBlob((e)=>a(e),t)});return a}const a=e.toDataURL(t),r=dataUrlToArrayBuffer(a);return new Blob([r],{type:t})}function blobToArrayBuffer(e){return new Promise((t,a)=>{const r=new FileReader;r.addEventListener('loadend',async()=>{t(r.result)}),r.addEventListener('error',a),r.readAsArrayBuffer(e)})}const DB_VERSION=4;class ImageDB{constructor(){const e=indexedDB.open('image-db',DB_VERSION);this.dbPromise=new Promise((t,a)=>{this.dbResolve=t,this.dbReject=a,e.onerror=(e)=>this.dbReject(e),e.onupgradeneeded=(e)=>this.createObjectStore(e),e.onsuccess=()=>this.dbOpened(e)})}storeRecord(e){null===e.id&&delete e.id;const t=new Promise((t,a)=>{this.dbPromise.then((r)=>{const n=r.transaction(['list'],'readwrite'),i=n.objectStore('list').put(e);i.onsuccess=()=>t(i.result),i.onerror=a}).catch(a)});return t}retrieveRecord(e){const t=new Promise((t,a)=>{this.dbPromise.then((r)=>{const n=r.transaction(['list'],'readonly'),i=n.objectStore('list').get(e);i.onsuccess=()=>t(i.result),i.onerror=a}).catch(a)});return t}deleteRecord(e,t=[]){const a=new Promise((a,r)=>{this.dbPromise.then((n)=>{const i=n.transaction(['list','media'],'readwrite');for(const e of t)i.objectStore('media').delete(e);i.objectStore('list').delete(e),i.oncomplete=()=>a(),i.onerror=r}).catch(r)});return a}storeRecordAndDeleteMedia(e,t=[]){if(null===e.id)return Promise.resolve(null);const a=new Promise((a,r)=>{this.dbPromise.then((n)=>{const i=n.transaction(['list','media'],'readwrite');for(const e of t)i.objectStore('media').delete(e);let o=null;const d=i.objectStore('list').put(e);d.onsuccess=()=>o=d.result,i.oncomplete=()=>a(o),i.onerror=r}).catch(r)});return a}async storeMedia(e,t){const a=await blobToArrayBuffer(e),r={media:a,type:e.type},n=new Promise((e,a)=>{this.dbPromise.then((n)=>{const i=n.transaction(['media'],'readwrite'),o=i.objectStore('media').put(r,t);o.onsuccess=()=>e(o.result),o.onerror=a}).catch(a)});return n}retrieveMedia(e){const t=new Promise((t,a)=>{this.dbPromise.then((r)=>{const n=r.transaction(['media'],'readonly'),i=n.objectStore('media').get(e);i.onsuccess=()=>{const e=i.result,a=new Blob([e.media],{type:e.type});t(a)},i.onerror=a}).catch(a)});return t}addSync(e){const t=new Promise((t,a)=>{return e.id||e.guid?void this.dbPromise.then((r)=>{const n=r.transaction(['sync'],'readwrite'),i=n.objectStore('sync').put(e);i.onsuccess=()=>t(),i.onerror=a}).catch(a):a('Neither local nor remote id was given')});return t}removeSync(e,t){const a=new Promise((a,r)=>{this.dbPromise.then((n)=>{if(!e&&!t)return r('Neither local nor remote id was given');const i=n.transaction(['sync'],'readwrite');i.objectStore('sync').delete([e,t]),i.oncomplete=()=>a(),i.onerror=r}).catch(r)});return a}listSync(){const e=new Promise((e,t)=>{this.dbPromise.then((a)=>{const r=a.transaction(['sync'],'readonly'),n=r.objectStore('sync').openCursor(),i=[];n.onsuccess=()=>{const t=n.result;t?(i.push(t.value),t.continue()):e(i)},n.onerror=t}).catch(t)});return e}setMeta(e,t){const a=new Promise((a,r)=>{this.dbPromise.then((n)=>{const i=n.transaction(['metadata'],'readwrite'),o=i.objectStore('metadata').put(t,e);o.onsuccess=()=>a(),o.onerror=r}).catch(r)});return a}getMeta(e){const t=new Promise((t,a)=>{this.dbPromise.then((r)=>{const n=r.transaction(['metadata'],'readonly'),i=n.objectStore('metadata').get(e);i.onsuccess=()=>t(i.result),i.onerror=a}).catch(a)});return t}all(){const e=new Promise((e,t)=>{this.dbPromise.then((a)=>{const r=a.transaction(['list'],'readonly'),n=r.objectStore('list').openCursor(),i=[];n.onsuccess=()=>{const t=n.result;t?(i.push(t.value),t.continue()):e(i)},n.onerror=t}).catch(t)});return e}dbOpened(e){this.dbResolve(e.result),this.dbPromise.then((e)=>{e.onerror=(e)=>this.error(e)})}error(e){console.error(e)}createObjectStore(e){const t=e.target,a=t.transaction,r=t.result;if(3>e.oldVersion){const t=r.createObjectStore('media',{autoIncrement:!0}),n=r.createObjectStore('list',{keyPath:'id',autoIncrement:!0});0!==e.oldVersion&&(2===e.oldVersion?this.upgrade2to3(t,n,a):r.deleteObjectStore('images'))}4>e.oldVersion&&(r.createObjectStore('metadata'),r.createObjectStore('sync',{keyPath:['id','guid']}))}upgrade2to3(e,t,a){const r=a.objectStore('images'),n=r.openCursor();n.onerror=(e)=>this.error(e),n.onsuccess=()=>{const r=n.result;if(r){const a=r.value,n={editedId:null,guid:'',id:null,lastSyncVersion:-1,localFilterChanges:!0,localImageChanges:!0,originalId:null,thumbnailId:null,transform:a.transform},i=e.put(a.original);i.onerror=(e)=>this.error(e),i.onsuccess=()=>{if(n.originalId=i.result,a.edited){const r=e.put(a.edited);r.onerror=(e)=>this.error(e),r.onsuccess=()=>{n.editedId=r.result,t.put(n)}}else t.put(n)},r.continue()}else a.db.deleteObjectStore('images')}}}const imageDB=new ImageDB,subscribers=new Map,pubsub={publish(e){if(subscribers.has(e.channel)){const t=subscribers.get(e.channel);console.log(`[PUBSUB] ${e.channel}: ${t.size} handlers`);for(const a of t)a(e)}},subscribe(e,t){subscribers.has(e)||subscribers.set(e,new Set),subscribers.get(e).add(t)},unsubscribe(e,t){if(subscribers.has(e)){const a=subscribers.get(e);a.has(t)&&a.delete(t)}}};navigator.serviceWorker&&navigator.serviceWorker.addEventListener('message',(e)=>{pubsub.publish(e.data)},!1);class User{constructor(){this.id='',this.name='',this.imageURL='',this.token='',this.tokenExpiry=0}}const user=new User;async function resume(){const e=await imageDB.getMeta('token'),t=await imageDB.getMeta('tokenExpiry');if(e&&1e3*t>Date.now())return validate(e)}function login(){const e=new URL('https://accounts.google.com/o/oauth2/v2/auth');e.searchParams.append('client_id',constants.CLIENT_ID),e.searchParams.append('redirect_uri',`${location.origin}/oauth`),e.searchParams.append('response_type','token'),e.searchParams.append('scope','profile https://www.googleapis.com/auth/drive'),window.location.replace(e.toString())}function logout(){user.token='',pubsub.publish({channel:'logout'})}async function validate(e){if(''!==e){const t=await fetch(`https://www.googleapis.com/oauth2/v3/tokeninfo?access_token=${e}`);if(!t.ok)return void(user.token='');const a=await t.json();if(a.aud===constants.CLIENT_ID){const t=await fetch(`https://www.googleapis.com/plus/v1/people/me?access_token=${e}`),r=await t.json();user.id=r.id,user.name=r.displayName,user.imageURL=r.image.url,user.token=e,user.tokenExpiry=a.exp,setTimeout(logout,1e3*a.expires_in),pubsub.publish({channel:'login'}),await imageDB.setMeta('token',e),await imageDB.setMeta('tokenExpiry',a.exp)}}}class ViewState{}var fragmentShader='\nprecision highp float;\nvarying vec2 texCoords;\nuniform sampler2D textureSampler;\nuniform vec2 sourceSize;\nuniform float saturation;\nuniform float warmth;\nuniform float sharpen;\nuniform float brightness;\nuniform float contrast;\nuniform float blur;\nuniform float vignette;\nuniform float grey;\nvec3 saturationVector = vec3(0.299, 0.587, 0.114);\nvoid main() {\n  vec2 off = sourceSize * blur;\n  vec2 off2 = off * 2.0;\n  vec4 tex00 = texture2D(textureSampler, texCoords + vec2(-off2.x, -off2.y));\n  vec4 tex10 = texture2D(textureSampler, texCoords + vec2(-off.x, -off2.y));\n  vec4 tex20 = texture2D(textureSampler, texCoords + vec2(0.0, -off2.y));\n  vec4 tex30 = texture2D(textureSampler, texCoords + vec2(off.x, -off2.y));\n  vec4 tex40 = texture2D(textureSampler, texCoords + vec2(off2.x, -off2.y));\n  vec4 tex01 = texture2D(textureSampler, texCoords + vec2(-off2.x, -off.y));\n  vec4 tex11 = texture2D(textureSampler, texCoords + vec2(-off.x, -off.y));\n  vec4 tex21 = texture2D(textureSampler, texCoords + vec2(0.0, -off.y));\n  vec4 tex31 = texture2D(textureSampler, texCoords + vec2(off.x, -off.y));\n  vec4 tex41 = texture2D(textureSampler, texCoords + vec2(off2.x, -off.y));\n  vec4 tex02 = texture2D(textureSampler, texCoords + vec2(-off2.x, 0.0));\n  vec4 tex12 = texture2D(textureSampler, texCoords + vec2(-off.x, 0.0));\n  vec4 tex22 = texture2D(textureSampler, texCoords + vec2(0.0, 0.0));\n  vec4 tex32 = texture2D(textureSampler, texCoords + vec2(off.x, 0.0));\n  vec4 tex42 = texture2D(textureSampler, texCoords + vec2(off2.x, 0.0));\n  vec4 tex03 = texture2D(textureSampler, texCoords + vec2(-off2.x, off.y));\n  vec4 tex13 = texture2D(textureSampler, texCoords + vec2(-off.x, off.y));\n  vec4 tex23 = texture2D(textureSampler, texCoords + vec2(0.0, off.y));\n  vec4 tex33 = texture2D(textureSampler, texCoords + vec2(off.x, off.y));\n  vec4 tex43 = texture2D(textureSampler, texCoords + vec2(off2.x, off.y));\n  vec4 tex04 = texture2D(textureSampler, texCoords + vec2(-off2.x, off2.y));\n  vec4 tex14 = texture2D(textureSampler, texCoords + vec2(-off.x, off2.y));\n  vec4 tex24 = texture2D(textureSampler, texCoords + vec2(0.0, off2.y));\n  vec4 tex34 = texture2D(textureSampler, texCoords + vec2(off.x, off2.y));\n  vec4 tex44 = texture2D(textureSampler, texCoords + vec2(off2.x, off2.y));\n  vec4 tex = tex22;\n  vec4 blurred = 1.0 * tex00 + 4.0 * tex10 + 6.0 * tex20 + 4.0 * tex30 + 1.0 * tex40\n               + 4.0 * tex01 + 16.0 * tex11 + 24.0 * tex21 + 16.0 * tex31 + 4.0 * tex41\n               + 6.0 * tex02 + 24.0 * tex12 + 36.0 * tex22 + 24.0 * tex32 + 6.0 * tex42\n               + 4.0 * tex03 + 16.0 * tex13 + 24.0 * tex23 + 16.0 * tex33 + 4.0 * tex43\n               + 1.0 * tex04 + 4.0 * tex14 + 6.0 * tex24 + 4.0 * tex34 + 1.0 * tex44;\n  blurred /= 256.0;\n  tex += (tex - blurred) * sharpen;\n  vec3 desaturated = vec3(dot(saturationVector, tex.rgb));\n  vec3 mixed = mix(desaturated, tex.rgb, saturation);\n  vec4 color = vec4(mixed, tex.a);\n  color.r += warmth;\n  color.b -= warmth;\n  vec3 greyVec = vec3(grey, grey, grey);\n  color.rgb = mix(color.rgb * brightness, mix(greyVec, color.rgb, contrast), 0.5);\n  float ratio = off.x / off.y;\n  float dist = sqrt(pow(texCoords.x - 0.5, 2.0) + pow(ratio * (texCoords.y - 0.5), 2.0));\n  float vigCurve = exp(-pow(dist, 2.0) / (2.0 * pow(-vignette, 2.0)));\n  color.rgb *= vigCurve;\n  gl_FragColor = color;\n}\n';const BASE_VERTEX_SHADER=`
attribute vec2 position;
attribute vec2 uv;

varying vec2 texCoords;

void main() {
  gl_Position = vec4(position, 0, 1.0);
  texCoords = uv;
}`,BASE_FRAGMENT_SHADER=`
precision highp float;

varying vec2 texCoords;

uniform sampler2D textureSampler;

void main() {
  gl_FragColor = texture2D(textureSampler, texCoords);
}`,POSITIONS=new Float32Array([-1,-1,-1,1,1,1,1,-1]),UVS=new Float32Array([0,1,0,0,1,0,1,1]),INDEX=new Uint16Array([0,1,2,0,2,3]);class ImageShader{constructor(){this.canvas=document.createElement('canvas');const e=this.canvas.getContext('webgl');if(null===e)throw new Error(`Couldn't get a WebGL context`);const t=e;this.context=t;const a=t.createTexture();if(null===a)throw new Error('Error getting texture ID');this.textureId=a,this.programId=0,this.vertShader=BASE_VERTEX_SHADER,this.fragShader=BASE_FRAGMENT_SHADER,this.uniformLocations=new Map,this.bindBuffers(INDEX,POSITIONS,UVS),t.clearColor(1,1,1,1),this.dirtyProgram=!0}setImage(e){const t=this.context;t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,this.textureId),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,e),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR)}setVertexShader(e){this.vertShader=e,this.dirtyProgram=!0}setFragmentShader(e){this.fragShader=e,this.dirtyProgram=!0}setUniform(e,t){const a=this.context;if(this.dirtyProgram&&this.createProgram(),!this.uniformLocations.has(e))return void console.warn(`Tried to set unknown uniform ${e}`);const r=this.uniformLocations.get(e);switch(r.type){case a.FLOAT:a.uniform1fv(r.location,[t]);break;case a.FLOAT_VEC2:a.uniform2fv(r.location,t);break;case a.FLOAT_VEC3:a.uniform3fv(r.location,t);break;case a.FLOAT_VEC4:a.uniform4fv(r.location,t);break;case a.BOOL:case a.INT:a.uniform1iv(r.location,[t]);break;case a.BOOL_VEC2:case a.INT_VEC2:a.uniform2iv(r.location,t);break;case a.BOOL_VEC3:case a.INT_VEC3:a.uniform3iv(r.location,t);break;case a.BOOL_VEC4:case a.INT_VEC4:a.uniform4iv(r.location,t);break;default:console.error(`Couldn't set uniform, unsupported type`);}}render(){const e=this.context;this.dirtyProgram&&this.createProgram(),e.viewport(0,0,e.drawingBufferWidth,e.drawingBufferHeight),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT),e.drawElements(e.TRIANGLES,6,e.UNSIGNED_SHORT,0),e.flush()}createProgram(){const e=this.context,t=this.compileShader(this.vertShader,e.VERTEX_SHADER),a=this.compileShader(this.fragShader,e.FRAGMENT_SHADER),r=e.createProgram();if(null===r)throw new Error(`Couldn't get a program ID`);if(this.programId=r,e.attachShader(r,t),e.attachShader(r,a),e.linkProgram(r),!e.getProgramParameter(r,e.LINK_STATUS)){const t=e.getProgramInfoLog(r);throw new Error('Could not link shader program. \n\n'+t)}if(e.validateProgram(r),!e.getProgramParameter(r,e.VALIDATE_STATUS)){const t=e.getProgramInfoLog(r);throw new Error('Could not validate shader program. \n\n'+t)}e.useProgram(r),this.uniformLocations=new Map,this.getUniformLocations(),this.dirtyProgram=!1}compileShader(e,t){const a=this.context,r=a.createShader(t);if(null===r)throw new Error('Error creating shader');if(a.shaderSource(r,e),a.compileShader(r),!a.getShaderParameter(r,a.COMPILE_STATUS))throw new Error(`Couldn't compiler shader: ${a.getShaderInfoLog(r)}`);return r}getUniformLocations(){const e=this.context,t=e.getProgramParameter(this.programId,e.ACTIVE_UNIFORMS);for(let a=0;a<t;a++){const t=e.getActiveUniform(this.programId,a);if(null===t)throw new Error(`Couldn't get uniform info`);const r=e.getUniformLocation(this.programId,t.name);r&&this.uniformLocations.set(t.name,{type:t.type,location:r})}}bindBuffers(e,t,a){const r=this.context;this.bindIndicesBuffer(e),this.bindAttributeBuffer(0,2,t),this.bindAttributeBuffer(1,2,a),r.enableVertexAttribArray(0),r.enableVertexAttribArray(1)}bindAttributeBuffer(e,t,a){const r=this.context,n=r.createBuffer();r.bindBuffer(r.ARRAY_BUFFER,n),r.bufferData(r.ARRAY_BUFFER,a,r.STATIC_DRAW),r.vertexAttribPointer(e,t,r.FLOAT,!1,0,0),r.bindBuffer(r.ARRAY_BUFFER,null)}bindIndicesBuffer(e){const t=this.context,a=t.createBuffer();t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,a),t.bufferData(t.ELEMENT_ARRAY_BUFFER,e,t.STATIC_DRAW)}}const shader=new ImageShader;shader.setFragmentShader(fragmentShader);const random=(e,t)=>{let a=Math.random();return a*=t-e,a+=e,a};class FilterTransform{static from(e){const t=new FilterTransform;return e&&(t.saturation=+e.saturation||t.saturation,t.warmth=+e.warmth||t.warmth,t.sharpen=+e.sharpen||t.sharpen,t.blur=+e.blur||t.blur,t.brightness=+e.brightness||t.brightness,t.contrast=+e.contrast||t.contrast,t.grey=+e.grey||t.grey,t.vignette=+e.vignette||t.vignette),t}constructor(){this.saturation=1,this.warmth=0,this.sharpen=0,this.blur=1,this.brightness=1,this.contrast=1,this.grey=0.5,this.vignette=2}randomize(){this.saturation=random(0,2),this.warmth=random(-0.08,0.08),this.sharpen=random(-2,2),this.blur=random(0.01,4),this.brightness=random(0,2),this.contrast=random(0,2),this.grey=random(0,1),this.vignette=random(0.2,2)}apply(e,t,a){let r,n,i=1;if(e instanceof HTMLImageElement?(r=e.naturalWidth,n=e.naturalHeight):e instanceof HTMLVideoElement?(r=e.videoWidth,n=e.videoHeight):(r=e.width,n=e.height),a&&a!==n){const o=document.createElement('canvas'),d=r/n;o.height=a*devicePixelRatio,o.width=o.height*d,o.getContext('2d').drawImage(e,0,0,o.width,o.height),shader.setImage(o),i=o.height/n,t.width=o.width,t.height=o.height}else shader.setImage(e),t.width=r,t.height=n;shader.canvas.width=t.width,shader.canvas.height=t.height,shader.setUniform('sourceSize',new Float32Array([1/t.width,1/t.height])),shader.setUniform('blur',i*this.blur),shader.setUniform('brightness',this.brightness),shader.setUniform('contrast',this.contrast),shader.setUniform('grey',this.grey),shader.setUniform('saturation',this.saturation),shader.setUniform('sharpen',this.sharpen),shader.setUniform('vignette',this.vignette),shader.setUniform('warmth',this.warmth),shader.render();const o=t.getContext('2d');o.drawImage(shader.canvas,0,0,shader.canvas.width,shader.canvas.height,0,0,t.width,t.height)}}var ImageState;(function(e){e[e.NotLoaded=0]='NotLoaded',e[e.Loaded=1]='Loaded',e[e.Changed=2]='Changed',e[e.OutOfDate=3]='OutOfDate'})(ImageState||(ImageState={}));class ImageRecord{static async fromDatabase(e){const t=await imageDB.retrieveRecord(e);return ImageRecord.fromListRecord(t)}static fromListRecord(e){const t=new ImageRecord;return t.id=e.id,t.guid=e.guid,t.originalState=ImageState.NotLoaded,t.editedState=ImageState.NotLoaded,t.thumbnailState=ImageState.NotLoaded,t.originalId=e.originalId,t.editedId=e.editedId,t.thumbnailId=e.thumbnailId,t.transform=FilterTransform.from(e.transform),t.localImageChanges=e.localImageChanges,t.localFilterChanges=e.localFilterChanges,t.lastSyncVersion=e.lastSyncVersion,t}static async getAll(){const e=await imageDB.all(),t=[];for(const a of e)t.push(ImageRecord.fromListRecord(a));return t}constructor(){this.id=null,this.guid='',this.originalState=ImageState.Changed,this.editedState=ImageState.Changed,this.thumbnailState=ImageState.Changed,this.originalId=null,this.editedId=null,this.thumbnailId=null,this.$transform=null,this.localImageChanges=!0,this.localFilterChanges=!0,this.lastSyncVersion=-1,this.originalCache=null,this.editedCache=null,this.thumbnailCache=null}get transform(){return this.$transform}set transform(e){this.$transform=e,this.editedState=ImageState.OutOfDate,this.thumbnailState=ImageState.OutOfDate,this.localFilterChanges=!0}async getOriginal(){return this.originalId&&this.originalState===ImageState.NotLoaded&&(this.originalCache=await imageDB.retrieveMedia(this.originalId),this.originalState=ImageState.Loaded),this.originalCache}async getEdited(){return this.editedId&&this.editedState===ImageState.NotLoaded&&(this.editedCache=await imageDB.retrieveMedia(this.editedId),this.editedState=ImageState.Loaded),this.editedId&&this.editedState!==ImageState.OutOfDate||(this.editedCache=await this.drawFiltered(),this.editedState=ImageState.Changed),this.editedCache}async getThumbnail(){return this.thumbnailId&&this.thumbnailState===ImageState.NotLoaded&&(this.thumbnailCache=await imageDB.retrieveMedia(this.thumbnailId),this.thumbnailState=ImageState.Loaded),this.thumbnailId&&this.thumbnailState!==ImageState.OutOfDate||(this.thumbnailCache=await this.drawFiltered(200),this.thumbnailState=ImageState.Changed),this.thumbnailCache}setOriginal(e){this.originalCache=e,this.originalState=ImageState.Changed,this.editedState=ImageState.OutOfDate,this.thumbnailState=ImageState.OutOfDate,this.localImageChanges=!0}async delete(){if(this.id){const e=[];return this.originalId&&e.push(this.originalId),this.editedId&&e.push(this.editedId),this.thumbnailId&&e.push(this.thumbnailId),imageDB.deleteRecord(this.id,e)}}async drawFiltered(e){const t=await this.getOriginal(),a=new Promise((a,r)=>{if(t){const n=document.createElement('img');n.onload=()=>{if(this.transform){const t=document.createElement('canvas');URL.revokeObjectURL(n.src),this.transform.apply(n,t,e),a(canvasToBlob(t,constants.IMAGE_TYPE))}else a(null)},n.onerror=r,n.src=URL.createObjectURL(t)}});return a}async save(){this.originalState===ImageState.Changed&&null!==this.originalCache&&(this.originalId=await imageDB.storeMedia(this.originalCache,this.originalId||void 0)),this.editedState===ImageState.OutOfDate&&(this.editedCache=await this.drawFiltered(),this.editedState=ImageState.Changed),this.editedState===ImageState.Changed&&null!==this.editedCache&&(this.editedId=await imageDB.storeMedia(this.editedCache,this.editedId||void 0)),this.thumbnailState===ImageState.OutOfDate&&(this.thumbnailCache=await this.drawFiltered(200),this.thumbnailState=ImageState.Changed),this.thumbnailState===ImageState.Changed&&null!==this.thumbnailCache&&(this.thumbnailId=await imageDB.storeMedia(this.thumbnailCache,this.thumbnailId||void 0));let e={};this.$transform&&(e=Object.assign({},this.$transform));const t=await imageDB.storeRecord({editedId:this.editedId,guid:this.guid,id:this.id,lastSyncVersion:this.lastSyncVersion,localFilterChanges:this.localFilterChanges,localImageChanges:this.localImageChanges,originalId:this.originalId,thumbnailId:this.thumbnailId,transform:e});this.id=t}}const DRIVE_API='https://www.googleapis.com/drive/v3/',DRIVE_UPLOAD_API='https://www.googleapis.com/upload/drive/v3/',COMMON_FILE_FIELDS='kind,id,name,mimeType,appProperties,trashed,version,size';function makeURL(e,t,a){const r=new URL(e);for(const n in t)r.searchParams.append(n,t[n]);if(a)for(const e in a)r.searchParams.append(e,a[e]);return r.toString()}async function driveRequest(e,t,a={}){if(!user.token)throw new Error('Not logged in');const r=makeURL(`${DRIVE_API}${e}`,{access_token:user.token},t),n=await fetch(r,a);return n.json()}async function driveMediaRequest(e,t,a={}){if(!user.token)throw new Error('Not logged in');const r=makeURL(`${DRIVE_API}${e}`,{access_token:user.token,alt:'media'},t),n=await fetch(r,a);return n.blob()}async function driveUploadRequest(e,t){if(!user.token)throw new Error('Not logged in');const a=makeURL(`${DRIVE_UPLOAD_API}${e}`,{access_token:user.token,uploadType:'media'}),r=await fetch(a,{method:'PATCH',body:t});return r.json()}async function getFileContent(e){return driveMediaRequest(`files/${e}`)}async function createFileMeta(e){return driveRequest(`files`,{fields:COMMON_FILE_FIELDS},{body:JSON.stringify(e),headers:{"Content-Type":'application/json'},method:'POST'})}async function updateFileMeta(e){const t={appProperties:e.appProperties,mimeType:e.mimeType,name:e.name};return driveRequest(`files/${e.id}`,{fields:COMMON_FILE_FIELDS},{body:JSON.stringify(t),headers:{"Content-Type":'application/json'},method:'PATCH'})}async function updateFileContent(e,t){return driveUploadRequest(`files/${e}`,t)}async function folderList(e){let t=[];const a={corpus:'user',fields:`files(${COMMON_FILE_FIELDS})`,q:`'${e}' in parents`,spaces:'drive'};let r='';do{r&&(a.nextPageToken=r);const e=await driveRequest('files',a);t=t.concat(e.files),r=e.nextPageToken}while(r);return t}let snapshotFolder=null;var ChangeType;(function(e){e[e.ADD=0]='ADD',e[e.REMOVE=1]='REMOVE',e[e.UPDATE=2]='UPDATE'})(ChangeType||(ChangeType={}));function syncStart(){syncFiles(),setInterval(syncFiles,constants.SYNC_FREQUENCY+1e3)}'window'in self&&pubsub.subscribe('login',syncStart);async function getSnapshotFolder(){if(snapshotFolder)return snapshotFolder;const e=await driveRequest('files',{corpus:'user',q:`name = '${constants.DRIVE_FOLDER}' and 'root' in parents`,spaces:'drive'});if(e&&1===e.files.length)return snapshotFolder=e.files[0],snapshotFolder;const t={mimeType:'application/vnd.google-apps.folder',name:constants.DRIVE_FOLDER,parents:['root']};return snapshotFolder=await createFileMeta(t),snapshotFolder}async function syncFiles(){if(!user.token)return;const e=+(await imageDB.getMeta('lastSyncTime'));if(console.log((Date.now()-e)/1e3,e+constants.SYNC_FREQUENCY,Date.now()),e+constants.SYNC_FREQUENCY>Date.now())return;let t;constants.SUPPORTS_BGSYNC&&(t=await navigator.serviceWorker.getRegistration());const a=await getSnapshotFolder(),r=await folderList(a.id),n=new Map,i=new Set,o=new Map;for(const e of r)e.id&&n.set(e.id,e);for(const e of await imageDB.all())n.has(e.guid)?(o.set(n.get(e.guid),e),n.delete(e.guid)):i.add(e);if(t){for(const e of n.values())e.trashed||imageDB.addSync({id:0,guid:e.id,upload:!1,includeMedia:!0});for(const e of i)imageDB.addSync({id:e.id,guid:'',upload:!0,includeMedia:!0});for(const[e,t]of o)e.trashed?(pubsub.publish({channel:'sync',data:{type:ChangeType.REMOVE,id:t.id}}),deleteLocal(t)):t.localFilterChanges||t.localImageChanges?imageDB.addSync({guid:e.id,id:t.id,includeMedia:t.localImageChanges,upload:!0}):t.lastSyncVersion<e.version&&imageDB.addSync({id:t.id,guid:e.id,upload:!1,includeMedia:!0});t.sync.register('sync')}else{for(const e of n.values())e.trashed||downloadRemote(e,!0);for(const e of i)uploadLocal(e,e.localImageChanges);for(const[e,t]of o)e.trashed?(pubsub.publish({channel:'sync',data:{type:ChangeType.REMOVE,id:t.id}}),deleteLocal(t)):t.localImageChanges||t.localFilterChanges?uploadLocal(t,t.localImageChanges,e):t.lastSyncVersion<e.version&&downloadRemote(e,!0,t)}imageDB.setMeta('lastSyncTime',Date.now())}async function deleteLocal(e){const t=[];e.originalId&&t.push(e.originalId),e.editedId&&t.push(e.editedId),e.thumbnailId&&t.push(e.thumbnailId),imageDB.deleteRecord(e.id,t)}async function downloadRemote(e,t,a){if(e.id){const t=await getFileContent(e.id);if(t){const r=a||{editedId:null,guid:'',id:null,lastSyncVersion:-1,localFilterChanges:!1,localImageChanges:!1,originalId:null,thumbnailId:null,transform:{}};if(r.guid=e.id,e.appProperties){const t=e.appProperties,a=r.transform||{};a.saturation=+t.saturation||a.saturation,a.warmth=+t.warmth||a.warmth,a.sharpen=+t.sharpen||a.sharpen,a.blur=+t.blur||a.blur,a.brightness=+t.brightness||a.brightness,a.contrast=+t.contrast||a.contrast,a.grey=+t.grey||a.grey,a.vignette=+t.vignette||a.vignette,r.transform=a}return r.localFilterChanges=!1,r.localImageChanges=!1,r.lastSyncVersion=e.version,r.originalId=await imageDB.storeMedia(t),await imageDB.storeRecord(r),pubsub.publish({channel:'sync',data:{type:ChangeType.ADD,id:r.id}}),r.id}console.log(`Could not fetch original image`)}}async function uploadLocal(e,t,a){if(e.originalId){const r=await imageDB.retrieveMedia(e.originalId);if(r){if(!a){const t=await getSnapshotFolder();if(!t||!t.id)return;a={mimeType:r.type,name:`${e.id}_${Date.now()}`,parents:[t.id]}}if(e.transform)for(const t in a.appProperties={},e.transform)a.appProperties[t]=e.transform[t]+'';if(a.id){const t=await updateFileMeta(a);e.lastSyncVersion=t.version}else{const t=await createFileMeta(a);if(!t.id)return;a.id=t.id,e.guid=t.id}if(t){const t=await updateFileContent(a.id,r);e.lastSyncVersion=t.version,e.localImageChanges=!1}return e.localFilterChanges=!1,imageDB.storeRecord(e)}}}class View{constructor(e){this.viewElement=e}show(){this.viewElement.classList.remove('hidden')}hide(){this.viewElement.classList.add('hidden')}getState(){return this.state||new ViewState}setState(e){this.state=e}}class BrowseView extends View{constructor(){super(document.getElementById('browse-view')),this.captureButton=document.getElementById('browse-capture-button'),this.uploadButton=document.getElementById('browse-upload-button'),this.loginButton=document.getElementById('login-button'),this.logoutButton=document.getElementById('logout-button'),this.loginBar=document.getElementById('login-bar'),this.userName=document.getElementById('user-name'),this.userImage=document.getElementById('user-image'),this.emptyListElement=document.getElementById('empty-browse-list'),this.listElement=document.getElementById('browse-list'),constants.SUPPORTS_MEDIA_DEVICES||this.captureButton.classList.add('hidden'),this.captureButton.addEventListener('click',()=>this.captureClick()),this.uploadButton.addEventListener('click',()=>this.uploadClick()),this.loginButton.addEventListener('click',()=>this.loginClick()),this.logoutButton.addEventListener('click',()=>this.logoutClick()),this.thumbnails=new Map,this.blobURLs=new Set,pubsub.subscribe('login',()=>this.authChanged()),pubsub.subscribe('logout',()=>this.authChanged()),pubsub.subscribe('sync',(e)=>this.syncHandler(e.data))}async show(){const e=await ImageRecord.getAll();for(const t of e)this.addThumbnail(t);this.setListVisibility(),super.show()}hide(){for(super.hide();this.listElement.hasChildNodes();)this.listElement.removeChild(this.listElement.lastChild);for(const e of this.blobURLs)URL.revokeObjectURL(e);this.thumbnails.clear(),this.blobURLs.clear()}captureClick(){router.visit('/capture')}uploadClick(){router.visit('/upload')}loginClick(){login()}logoutClick(){logout()}authChanged(){''===user.id?(this.loginBar.classList.remove('logged-in'),this.loginBar.classList.add('logged-out')):(this.loginBar.classList.add('logged-in'),this.loginBar.classList.remove('logged-out'),this.userName.innerText=user.name,this.userImage.src=user.imageURL)}setListVisibility(){0===this.thumbnails.size?(this.emptyListElement.classList.remove('hidden'),this.listElement.classList.add('hidden')):(this.emptyListElement.classList.add('hidden'),this.listElement.classList.remove('hidden'))}async addThumbnail(e){const t=document.createElement('div');t.classList.add('element'),t.addEventListener('click',()=>router.visit(`/edit/${e.id}`)),this.thumbnails.set(e.id,t);const a=await e.getThumbnail();if(a){const e=URL.createObjectURL(a),r=document.createElement('img');r.src=e,t.appendChild(r),this.blobURLs.add(e)}else;this.listElement.appendChild(t)}async syncHandler(e){switch(e.type){case ChangeType.REMOVE:this.thumbnails.has(e.id)&&(this.listElement.removeChild(this.thumbnails.get(e.id)),this.thumbnails.delete(e.id));break;case ChangeType.ADD:this.addThumbnail((await ImageRecord.fromDatabase(e.id)));break;case ChangeType.UPDATE:this.thumbnails.has(e.id)&&this.listElement.removeChild(this.thumbnails.get(e.id)),this.addThumbnail((await ImageRecord.fromDatabase(e.id)));}this.setListVisibility()}}const streamConstraints={video:{deviceId:'',facingMode:['user','environment'],height:{ideal:1080},width:{ideal:1920}}};let supportedConstraints={};constants.SUPPORTS_MEDIA_DEVICES&&(supportedConstraints=navigator.mediaDevices.getSupportedConstraints());class CameraHelper{constructor(){this.stream=null,this.track=null,this.photoCapabilities=null,this.trackConstraints={},this.flash='off'}async getCameras(){let e=[];return constants.SUPPORTS_MEDIA_DEVICES&&(e=await navigator.mediaDevices.enumerateDevices(),e=e.filter((e)=>'videoinput'===e.kind)),e}async takePhoto(e){if(!constants.SUPPORTS_MEDIA_DEVICES)return null;if(constants.SUPPORTS_IMAGE_CAPTURE){const t=e.srcObject;if(!t)return null;const a=t.getVideoTracks()[0],r=new ImageCapture(a),n={};return this.photoCapabilities&&this.photoCapabilities.fillLightMode.includes(this.flash)&&(n.fillLightMode=this.flash),await r.takePhoto(n)}const t=document.createElement('canvas'),a=t.getContext('2d');return t.width=e.videoWidth,t.height=e.videoHeight,a.drawImage(e,0,0),await canvasToBlob(t,constants.IMAGE_TYPE)}stopStream(){if(this.stream)for(const e of this.stream.getVideoTracks())e.stop()}async startStream(e){this.stopStream(),streamConstraints.video.deviceId=e;const t=await navigator.mediaDevices.getUserMedia(streamConstraints);if(this.stream=t,this.track=t.getVideoTracks()[0],constants.SUPPORTS_IMAGE_CAPTURE){const e=new ImageCapture(this.track);this.photoCapabilities=await e.getPhotoCapabilities()}return this.trackConstraints={},t}getPhotoCapabilities(){return this.photoCapabilities?{flash:this.photoCapabilities.fillLightMode,redEyeReduction:'controllable'===this.photoCapabilities.redEyeReduction}:{flash:[],redEyeReduction:!1}}getSettings(){return this.track&&this.track.getSettings?this.track.getSettings():{}}}class CaptureView extends View{constructor(){super(document.getElementById('capture-view')),this.videoElement=this.viewElement.querySelector('video#preview'),this.videoElement2=this.viewElement.querySelector('video#preview2'),this.takePhotoButton=document.getElementById('capture-button'),this.cameraChooseButton=document.getElementById('camera-choose-button'),this.mirrorButton=document.getElementById('capture-mirror-button'),this.flashButton=document.getElementById('capture-flash-button'),this.closeButton=document.getElementById('capture-view-close'),this.videoElement2.classList.add('hidden'),this.cameraHelper=new CameraHelper,this.takePhotoButton.addEventListener('click',()=>this.takePhoto()),this.cameraChooseButton.addEventListener('click',()=>this.toggleCameraChooser()),this.mirrorButton.addEventListener('click',()=>this.toggleMirror()),this.flashButton.addEventListener('click',()=>this.toggleFlash()),this.closeButton.addEventListener('click',()=>this.close()),this.devicesPromise=this.getDevices(),this.currentDevice=null}show(){this.devicesPromise.then((e)=>{this.chooseCamera(e[0])}),super.show()}hide(){this.cameraHelper.stopStream(),this.videoElement.pause(),super.hide()}async getDevices(){const e=await this.cameraHelper.getCameras();return 2>e.length?this.cameraChooseButton.classList.add('hidden'):this.cameraChooseButton.classList.remove('hidden'),e}async takePhoto(){const e=await this.cameraHelper.takePhoto(this.videoElement);e&&this.storeResult(e)}async toggleCameraChooser(){const e=await this.devicesPromise;if(!(2>e.length))if(this.currentDevice){const t=e.indexOf(this.currentDevice);this.chooseCamera(e[(t+1)%e.length])}else this.chooseCamera(e[0])}close(){router.visit(`/browse`)}async chooseCamera(e){this.currentDevice=e,await this.startStream(this.currentDevice.deviceId);const t=this.cameraHelper.getPhotoCapabilities(),a=this.cameraHelper.getSettings();'user'===a.facingMode?this.videoElement.classList.add('mirror'):this.videoElement.classList.remove('mirror'),this.flashButton.classList.remove('flash-flash','flash-off','flash-auto'),this.flashButton.classList.add(`flash-${this.cameraHelper.flash}`),0<t.flash.length?this.flashButton.classList.remove('hidden'):this.flashButton.classList.add('hidden')}async storeResult(e){const t=new ImageRecord;t.setOriginal(e),await t.save(),router.visit(`/edit/${t.id}`)}async startStream(e){const t=await this.cameraHelper.startStream(e);return this.videoElement2.srcObject=t,new Promise((e)=>{this.videoElement2.onloadedmetadata=()=>{const t=this.videoElement;this.videoElement=this.videoElement2,this.videoElement2=t,this.videoElement.play(),this.videoElement.classList.remove('hidden'),this.videoElement2.classList.add('hidden'),this.videoElement2.pause(),e()}})}toggleMirror(){this.videoElement.classList.toggle('mirror')}toggleFlash(){this.flashButton.classList.remove(`flash-${this.cameraHelper.flash}`);const e=this.cameraHelper.getPhotoCapabilities();let t=e.flash.indexOf(this.cameraHelper.flash);t=(t+1)%e.flash.length,this.cameraHelper.flash=e.flash[t],this.flashButton.classList.add(`flash-${this.cameraHelper.flash}`)}}const namedFilters=[{name:'Grimsby',values:new FilterTransform},{name:'Slough',values:new FilterTransform},{name:'Burnley',values:new FilterTransform},{name:'Carlisle',values:new FilterTransform},{name:'Stevenage',values:new FilterTransform},{name:'Hull',values:new FilterTransform},{name:'Swansea',values:new FilterTransform},{name:'Luton',values:new FilterTransform},{name:'Glasgow',values:new FilterTransform},{name:'Dull',values:new FilterTransform}];class EditView extends View{constructor(){super(document.getElementById('edit-view')),this.destElement=document.getElementById('edit-dest'),this.closeButton=document.getElementById('edit-view-close'),this.acceptButton=document.getElementById('edit-view-accept'),this.filterSectionButton=document.getElementById('edit-select-filters'),this.tuneSectionButton=document.getElementById('edit-select-tuning'),this.filterSection=document.getElementById('edit-filter'),this.tuneSection=document.getElementById('edit-tune'),this.closeButton.addEventListener('click',()=>this.closeClick()),this.acceptButton.addEventListener('click',()=>this.acceptClick()),this.filterSectionButton.addEventListener('click',()=>this.toggleSection()),this.tuneSectionButton.addEventListener('click',()=>this.toggleSection()),this.transform=new FilterTransform,this.sliders=new Map;const e=this.viewElement.getElementsByTagName('input');for(const t of Array.from(e))this.sliders.set(t.id,t),t.addEventListener('input',()=>{this.transform[t.id]=+t.value/50,this.animationFrame||(this.animationFrame=requestAnimationFrame(()=>this.draw()))});for(const e of namedFilters){e.values.randomize();const t=document.createElement('button');t.classList.add('filter-button'),t.id=`filter-button-${e.name.toLowerCase()}`,t.setAttribute('aria-label',e.name),t.tabIndex=0,t.addEventListener('click',()=>this.filterButtonClick(e));const a=document.createElement('canvas');a.classList.add('filter-thumbnail'),t.appendChild(a),this.filterSection.appendChild(t)}this.effectButtons=new Set(this.viewElement.querySelectorAll('button.effect-button'));for(const e of this.effectButtons)e.addEventListener('click',()=>this.effectButtonClick(e));this.sourceElement=null,this.currentPanel=null,this.currentRecord=null}async show(){const e=this.getState();if(this.setTransform(e.transform||new FilterTransform),!e.id)throw new Error(`Couldn't get id of image`);const t=await ImageRecord.fromDatabase(e.id);this.currentRecord=t,this.setTransform(t.transform||new FilterTransform);const a=await t.getOriginal(),r=document.createElement('img');this.sourceElement=r,r.onload=()=>{URL.revokeObjectURL(r.src),this.transform.apply(r,this.destElement),this.animationFrame=requestAnimationFrame(()=>this.draw()),this.renderThumbnails()},r.src=URL.createObjectURL(a),super.show()}hide(){cancelAnimationFrame(this.animationFrame),this.sourceElement=null,this.animationFrame=0,this.currentRecord=null,this.currentPanel&&this.currentPanel.classList.add('hidden'),super.hide()}getState(){const e=super.getState();return e.transform=e.transform||new FilterTransform,e}setState(e){e.transform&&this.setTransform(e.transform),super.setState(e)}renderThumbnails(){if(this.sourceElement)for(const e of namedFilters){const t=document.querySelector(`#filter-button-${e.name.toLowerCase()} .filter-thumbnail`);t?setTimeout(()=>{e.values.apply(this.sourceElement,t,100)},0):console.error(`No output thumbnail for filter ${e.name}`)}}setTransform(e){if(e instanceof FilterTransform)this.transform=e;else for(const t of Object.getOwnPropertyNames(this.transform))e[t]&&(this.transform[t]=e[t]);for(const[t,a]of this.sliders)a.value=50*this.transform[t]+''}draw(){this.sourceElement&&this.transform.apply(this.sourceElement,this.destElement),this.animationFrame=0}filterButtonClick(e){this.setTransform(e.values),this.animationFrame||(this.animationFrame=requestAnimationFrame(()=>this.draw()))}effectButtonClick(e){const t=this.viewElement.querySelector(`#${e.id}-panel`);this.currentPanel?(this.currentPanel.classList.add('hidden'),this.currentPanel===t?this.currentPanel=null:(this.currentPanel=t,t.classList.remove('hidden'))):(this.currentPanel=t,t.classList.remove('hidden'))}toggleSection(){this.filterSection.classList.toggle('selected'),this.tuneSection.classList.toggle('selected'),this.filterSectionButton.classList.toggle('selected'),this.tuneSectionButton.classList.toggle('selected'),this.currentPanel&&(this.currentPanel.classList.add('hidden'),this.currentPanel=null)}async save(){this.currentRecord&&(this.currentRecord.transform=this.transform,this.currentRecord.save())}closeClick(){router.visit(`/browse`)}acceptClick(){this.save().then(()=>{router.visit(`/browse`)})}}class UploadView extends View{constructor(){super(document.getElementById('upload-view')),this.uploadInput=document.getElementById('upload-file-input'),this.uploadButton=document.getElementById('upload-button'),this.uploadDropTarget=document.getElementById('upload-drop-target'),this.closeButton=document.getElementById('upload-view-close'),this.uploadInput.addEventListener('change',()=>this.inputChange()),this.uploadButton.addEventListener('click',()=>this.triggerUpload()),this.uploadDropTarget.addEventListener('drop',(t)=>this.dropHandler(t)),this.uploadDropTarget.addEventListener('dragover',(t)=>this.dragOverHandler(t)),this.closeButton.addEventListener('click',()=>this.close())}inputChange(){this.ingest(this.uploadInput.files)}triggerUpload(){this.uploadInput.click()}dragOverHandler(t){t.stopPropagation(),t.preventDefault(),t.dataTransfer.dropEffect='copy'}dropHandler(t){t.stopPropagation(),t.preventDefault(),this.ingest(t.dataTransfer.files)}async ingest(e){if(0!==e.length){const t=e[0],a=new ImageRecord;a.setOriginal(t),await a.save(),router.visit(`/edit/${a.id}`)}}close(){router.visit(`/browse`)}}class Router{constructor(){window.addEventListener('popstate',(t)=>this.changeHandler(t.state)),this.browseView=new BrowseView,this.captureView=new CaptureView,this.editView=new EditView,this.uploadView=new UploadView}changeHandler(e){if(window.location.pathname===this.currentLocation)return;this.currentLocation=window.location.pathname;const t=this.currentLocation.split('/');this.currentView&&this.currentView.hide(),e||(e=new ViewState);let a=null;switch(t[1]){case'capture':a=this.captureView;break;case'':case'browse':a=this.browseView;break;case'edit':a=this.editView,e.id=+t[2];break;case'upload':a=this.uploadView;break;case'oauth':return void this.handleOAuth().then(()=>{this.visit('/')});default:console.log('404');}a?this.switch(a,e):console.log('Oh no, no view found!')}switch(e,t){this.currentView&&this.currentView.hide(),e.setState(t),e.show(),this.currentView=e}visit(e){if(window.location.href===e)return;let t;this.currentView&&(t=this.currentView.getState()),window.history.replaceState(t,'',window.location.href),window.history.pushState(null,'',e),this.changeHandler()}click(e){const t=e.target;e.metaKey||e.ctrlKey||0!==e.button||(e.preventDefault(),this.visit(t.href))}handleOAuth(){const e=window.location.hash,t=e.substring(1).split('&');let a='';for(const e of t){const[t,r]=e.split('=');'access_token'===t&&(a=r)}return validate(a)}}var router=new Router;'serviceWorker'in navigator&&navigator.serviceWorker.register('/sw.js'),router.changeHandler(),resume();
//# sourceMappingURL=app.min.js.map
